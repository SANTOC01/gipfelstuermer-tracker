<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gipfelstürmer Event 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; padding: 20px; }
        input, button { margin: 10px; padding: 10px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 8px; background: white; }
        canvas { margin-top: 20px; }
        .progress-bar { width: 100%; background: #ddd; border-radius: 20px; }
        .progress { height: 30px; width: 0%; background: #4caf50; text-align: center; color: white; border-radius: 20px; transition: width 0.5s; }
        .goal { font-size: 20px; font-weight: bold; margin-top: 10px; }
        .banner { background: #ffcc00; padding: 10px; font-size: 18px; font-weight: bold; margin: 10px auto; display: none; width: 80%; border-radius: 10px; }
    </style>
</head>
<body>
    <h1>🏃 Gipfelstürmer Event 2025 🏔️</h1>
    <p>Gemeinsam sammeln wir 75.000 Höhenmeter bis zum 27.07.2025!</p>
    
    <div id="goalBanner" class="banner"></div>
    
    <input type="text" id="name" placeholder="Dein Name">
    <input type="number" id="hohenmeter" placeholder="Höhenmeter">
    <button onclick="submitData()">Absenden</button>
    
    <h2>📋 Letzte Einträge</h2>
    <table id="dataTable">
        <tr><th>Name</th><th>Höhenmeter</th><th>Datum</th><th>Löschen</th></tr>
    </table>
    
    <h2>📈 Fortschritt – Gesamt: <span id='totalHM'>0</span> HM</h2>
    <div class="progress-bar">
        <div class="progress" id="progressBar">0%</div>
    </div>
    <canvas id="myChart"></canvas>
    
    <h2 class="goal" id="latestGoal">🏆 Letztes erreichtes Ziel: -</h2>
    
    <h2>🏆 Belohnungen</h2>
    <ul id="goalList">
        <li id="goal1">🎭 <b>10.000 HM</b> → Trainer im Kostüm</li>
        <li id="goal2">🍕 <b>25.000 HM</b> → Pizza nach dem Lauf</li>
        <li id="goal3">🥤 <b>50.000 HM</b> → Geheimsnack & Getränke</li>
        <li id="goal4">🍰 <b>75.000 HM</b> → Erdbeertorte & Urkunden!</li>
    
    </ul>
    
   <script>
    const sheetURL = "https://script.google.com/macros/s/AKfycbz3JyX_QJNnhKJmP7K_rUJ-FprgFd0q--WBGv8_oS1FtqfOZ-pJ0Q0WEWqcxgf2gjP7/exec";
    let chart;

    async function submitData() {
        const name = document.getElementById("name").value;
        const hohenmeter = document.getElementById("hohenmeter").value;
        
        if (!name || !hohenmeter) {
            alert("Bitte beide Felder ausfüllen!");
            return;
        }
        
        await fetch(`${sheetURL}?action=add&name=${encodeURIComponent(name)}&hohenmeter=${encodeURIComponent(hohenmeter)}`);
        alert("Eingetragen! Danke fürs Mitmachen! 🎉");
        loadData();
    }

    async function deleteData(name, hohenmeter) {
        await fetch(`${sheetURL}?action=delete&name=${encodeURIComponent(name)}&hohenmeter=${encodeURIComponent(hohenmeter)}`);
        alert("Eintrag gelöscht!");
        loadData();
    }

    async function loadData() {
        const response = await fetch(`${sheetURL}?action=get`);
        const data = await response.json();
        const table = document.getElementById("dataTable");
        
        table.innerHTML = "<tr><th>Name</th><th>Höhenmeter</th><th>Datum</th><th>Löschen</th></tr>";
        let total = 0;
        let progressData = [];

        data.slice(1).forEach(row => {
            table.innerHTML += `<tr>
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${new Date(row[2]).toLocaleDateString()}</td>
                <td><button onclick="deleteData('${row[0]}', '${row[1]}')">❌</button></td>
            </tr>`;
            total += parseInt(row[1]);
            progressData.push(parseInt(row[1]));
        });
        
        updateProgress(total);
        drawChart(progressData);
        checkGoals(total);
    }

    function updateProgress(total) {
        const percentage = (total / 75000) * 100;
        document.getElementById("progressBar").style.width = percentage + "%";
        document.getElementById("progressBar").textContent = Math.round(percentage) + "%";
        document.getElementById("totalHM").textContent = total;
    }

    function drawChart(progressData) {
        const ctx = document.getElementById("myChart").getContext("2d");
        if (chart) {
            chart.destroy();
        }
        
        // Create an array for cumulative progress
        let cumulativeProgress = progressData.reduce((acc, cur) => {
            let last = acc.length > 0 ? acc[acc.length - 1] : 0;
            acc.push(last + cur);
            return acc;
        }, []);

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: ["Start", ...cumulativeProgress.map((_, i) => `Point ${i + 1}`), "75k"],
                datasets: [
                    {
                        label: "Ziele",
                        data: [0, 10000, 25000, 50000, 75000],
                        borderColor: "saddlebrown",
                        backgroundColor: "rgba(139, 69, 19, 0.2)",
                        fill: true,
                        tension: 0.4,
                        pointStyle: 'circle',
                        pointRadius: 5,
                        pointBackgroundColor: "saddlebrown"
                    },
                    {
                        label: "Fortschritt",
                        data: [0, ...cumulativeProgress, cumulativeProgress[cumulativeProgress.length - 1]],
                        borderColor: "green",
                        backgroundColor: "rgba(0, 128, 0, 0.4)",
                        fill: true,
                        tension: 0.4,
                        pointStyle: 'triangle',
                        pointRadius: 5,
                        pointBackgroundColor: "green"
                    }
                ]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        suggestedMin: 0,
                        suggestedMax: 80000
                    },
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        // Add emoji marker (🏃‍➡️) for current progress
        const runnerEmoji = '🏃‍➡️';
        chart.data.datasets[1].pointRadius = 0; // Hide original points
        chart.data.datasets[1].pointStyle = 'triangle'; // Hide original points
        
        chart.update();

        // Adding custom emoji marker after the update
        const meta = chart.getDatasetMeta(1);
        meta.data.forEach((point, index) => {
            if (index === meta.data.length - 1) {
                const props = point.getProps(['x', 'y'], true);
                chart.ctx.fillText(runnerEmoji, props.x, props.y);
            }
        });
    }

    function checkGoals(total) {
        const goals = [10000, 25000, 50000, 75000];
        let lastGoal = "-";
        goals.forEach((goal, index) => {
            if (total >= goal) {
                document.getElementById(`goal${index + 1}`).style.color = "green";
                lastGoal = document.getElementById(`goal${index + 1}`).innerHTML;
            }
        });
        if (lastGoal === "-") {
            document.getElementById("goalBanner").innerHTML = "🎉 Noch kein Ziel erreicht!";
        } else {
            document.getElementById("goalBanner").innerHTML = `🎉 Ziel erreicht: ${lastGoal.replace(/<[^>]*>/g, '')}!`;
        }
        document.getElementById("latestGoal").innerHTML = `🏆 Letztes erreichtes Ziel: ${lastGoal}`;
        document.getElementById("goalBanner").style.display = "block";
    }

    loadData();
</script>

</body>
</html>
