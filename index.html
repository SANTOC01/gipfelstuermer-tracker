<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gipfelst√ºrmer Event 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f4f4f4;
      padding: 20px;
    }

    .banner-container {
      position: relative;
    }

    .banner-img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }

    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }

    .box {
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin: 10px 0;
      flex: 1 1 45%;
      min-width: 300px;
      color: black;
    }

    /* Ensure box text is black */
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 50px;
    }

    .table-container {
      width: 50%;
    }

    .ranking-container {
      width: 30%;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid black;
      padding: 8px;
      background: white;
      text-align: left;
      color: black;
    }

    /* Ensure table text is black */
    canvas {
      margin-top: 20px;
    }

    .progress-bar {
      width: 100%;
      background: #ddd;
      border-radius: 20px;
    }

    .progress {
      height: 30px;
      width: 0%;
      background: #4caf50;
      text-align: center;
      color: white;
      border-radius: 20px;
      transition: width 0.5s;
    }

    .goal {
      font-size: 20px;
      font-weight: bold;
      margin-top: 10px;
    }

    .banner {
      background: #ffcc00;
      padding: 10px;
      font-size: 18px;
      font-weight: bold;
      margin: 10px auto;
      display: none;
      width: 80%;
      border-radius: 10px;
    }

    h1 {
      font-weight: bold;
      color: white;
      text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    }

    .goal-container {
      display: flex;
      justify-content: center;
      align-items: center;
      background: lightbrown; /* Light brown to resemble a wooden board */
      padding: 30px;
      border-radius: 20px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }

    .goal-list {
      list-style-type: none;
      padding: 20px;
      background: white; /* Makes it look like a paper on the wooden board */
      border-radius: 10px;
      width: 80%; /* Adjust the width if needed */
      margin: 0;
    }

    .goal-list li {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .goal-list li input {
      margin-right: 10px;
    }

    .goal-list .completed {
      color: green;
      text-decoration: line-through;
    }

    .flex-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }

    .box {
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 10px;
      flex: 1 1 45%; /* Flex-grow: 1, Flex-shrink: 1, Flex-basis: 45% */
      margin: 10px 0;
      min-width: 300px; /* Minimum width for each box */
    }
  </style>


</head>
<body>
<div class="banner-container">
  <img
      src="https://raw.githubusercontent.com/SANTOC01/gipfelstuermer-tracker/refs/heads/main/mountain.jpg"
      alt="Mountain Banner" class="banner-img"/>
  <div class="overlay">
    <h1>RUNWOINEM'S Gipfelst√ºrmer Event 2025</h1>
    <input type="text" id="name" placeholder="Dein Name"/>
    <input type="number" id="hohenmeter" placeholder="H√∂henmeter" max="1200"
           oninput="validateHohenmeter()"/>
    <button onclick="submitData()">Absenden</button>
    <div id="goalBanner" class="banner"></div>

    <div class="flex-container">
      <div class="box">
        <h2>üìã Letzte Eintr√§ge</h2>
        <table id="dataTable">
          <tr>
            <th>Name</th>
            <th>H√∂henmeter</th>
            <th>Datum</th>
            <th>L√∂schen</th>
          </tr>
        </table>
      </div>

      <div class="box">
        <h2>üèÜ H√∂henmeter-Helden</h2>
        <table id="rankingTable">
          <tr>
            <th>Platz</th>
            <th>Name</th>
            <th>H√∂henmeter</th>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<h2>üìà Fortschritt ‚Äì Gesamt: <span id='totalHM'>0</span> HM</h2>
<div class="progress-bar">
  <div class="progress" id="progressBar">0%</div>
</div>
<canvas id="myChart"></canvas>

<h2>üèÜ Belohnungen</h2>
<div class="goal-container">
  <ul id="goalList" class="goal-list">
    <li><input type="checkbox" id="goal1Check" disabled/><label for="goal1Check">üé≠ <b>10.000 HM</b>
      ‚Üí Trainer im Kost√ºm</label></li>
    <li><input type="checkbox" id="goal2Check" disabled/><label for="goal2Check">üçï <b>25.000 HM</b>
      ‚Üí Pizza nach dem Lauf</label></li>
    <li><input type="checkbox" id="goal3Check" disabled/><label for="goal3Check">ü•§ <b>50.000 HM</b>
      ‚Üí Geheimsnack & Getr√§nke</label></li>
    <li><input type="checkbox" id="goal4Check" disabled/><label for="goal4Check">üç∞ <b>75.000 HM</b>
      ‚Üí Erdbeertorte & Urkunden!</label></li>
  </ul>
</div>

<script>
  const sheetURL = "https://script.google.com/macros/s/AKfycbxbt57SZfghrZTx9FXgl2IkqJfkQzvK1slJDJFE_osfPfJHRXXypsOp-zXRh2d9rzPQ/exec";
  let chart; // Global chart instance

  async function submitData() {
    const name = document.getElementById("name").value;
    const hohenmeter = document.getElementById("hohenmeter").value;

    if (!name || !hohenmeter) {
      alert("Bitte beide Felder ausf√ºllen!");
      return;
    }

    await fetch(
        `${sheetURL}?action=add&name=${encodeURIComponent(name)}&hohenmeter=${encodeURIComponent(
            hohenmeter)}`);
    alert("Eingetragen! Danke f√ºrs Mitmachen! üéâ");
    loadData();
  }

  async function deleteData(name, hohenmeter) {
    await fetch(
        `${sheetURL}?action=delete&name=${encodeURIComponent(name)}&hohenmeter=${encodeURIComponent(
            hohenmeter)}`);
    alert("Eintrag gel√∂scht!");
    loadData();
  }

  function validateHohenmeter() {
    const hmInput = document.getElementById("hohenmeter");
    const value = Number(hmInput.value);
    if (value > 1200) {
      alert("Sei ehrlich ü§•üòè");
      // Optionally, to enforce the limit, you can reset the input:
      // hmInput.value = 1200;
    }
  }

  async function loadData() {
    const response = await fetch(`${sheetURL}?action=get`);
    const data = await response.json();

    const mainData = data.main.reverse(); // Main table data
    const rankingData = data.ranking.sort((a, b) => b[1] - a[1]); // Sort ranking descending

    document.getElementById(
        "dataTable").innerHTML = "<tr><th>Name</th><th>H√∂henmeter</th><th>Datum</th><th>L√∂schen</th></tr>";
    let total = 0;

    mainData.forEach((row, index) => {
      total += parseInt(row[1]);
      document.getElementById("dataTable").innerHTML += `<tr>
          <td>${row[0]}</td>
          <td>${row[1]}</td>
          <td>${new Date(row[2]).toLocaleDateString()}</td>
          <td>${index === 0 ? `<button onclick="deleteData('${row[0]}', '${row[1]}')">‚ùå</button>`
          : ""}</td>
        </tr>`;
    });

    updateProgress(total);
    drawChart(total);
    updateRanking(rankingData);
    checkGoals(total);
  }

  async function updateRanking(rankingData) {
    const rankingTable = document.getElementById("rankingTable");
    rankingTable.innerHTML = "<tr><th>Platz</th><th>Name</th><th>H√∂henmeter</th></tr>";

    rankingData.forEach((row, index) => {
      let rankEmoji = "üòé"; // Default emoji
      if (index === 0) {
        rankEmoji = "üèÜ";
      }// First place
      else if (index === 1) {
        rankEmoji = "üî•";
      }// Second place
      else if (index === 2) {
        rankEmoji = "üí™";
      } // Third place

      rankingTable.innerHTML += `<tr>
          <td>${index + 1} ${rankEmoji}</td>
          <td>${row[0]}</td>
          <td>${row[1]}</td>
        </tr>`;
    });
  }

  function updateProgress(total) {
    const percentage = (total / 75000) * 100;
    document.getElementById("progressBar").style.width = percentage + "%";
    document.getElementById("progressBar").textContent = Math.round(percentage) + "%";
    document.getElementById("totalHM").textContent = total;
  }

  function drawChart(total) {
    const ctx = document.getElementById("myChart").getContext("2d");
    if (chart) {
      chart.destroy();
    }

    // Fixed mountain shape data ‚Äì feel free to adjust these points to tweak the mountain's form.
    const mountainData = [
      {x: 0, y: 0},
      {x: 10000, y: 8000},
      {x: 25000, y: 15000},
      {x: 50000, y: 40000},
      {x: 75000, y: 75000}
    ];

    // Build the progress (green) dataset by following the mountain line.
    const progressData = [];
    progressData.push({x: mountainData[0].x, y: mountainData[0].y}); // Always start at the base

    // Walk through each segment of the mountain.
    for (let i = 0; i < mountainData.length - 1; i++) {
      const startPoint = mountainData[i];
      const endPoint = mountainData[i + 1];
      // If the progress (total) has exceeded the end of this segment, add the full end point.
      if (total >= endPoint.y) {
        progressData.push({x: endPoint.x, y: endPoint.y});
      }
      // If total falls between the start and end, interpolate the x value.
      else if (total > startPoint.y) {
        const ratio = (total - startPoint.y) / (endPoint.y - startPoint.y);
        const interpolatedX = startPoint.x + ratio * (endPoint.x - startPoint.x);
        progressData.push({x: interpolatedX, y: total});
        break;
      } else {
        // If total isn‚Äôt even above the start of this segment, break out.
        break;
      }
    }

    const lastPoint = progressData[progressData.length - 1];
    const currentProgressData = [lastPoint];

    chart = new Chart(ctx, {
      type: "line",
      data: {
        datasets: [
          {
            label: "Fortschritt",
            data: progressData,
            borderColor: "green",
            backgroundColor: "rgba(0,128,0,0.4)",
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: function (context) {
              return (context.dataIndex === context.dataset.data.length - 1) ? 10 : 0;
            },
            pointBackgroundColor: "green",
            pointStyle: "circle",
            z: 2
          },
          {
            label: "Ziele",
            data: mountainData,
            borderColor: "saddlebrown",
            backgroundColor: "rgba(139, 69, 19, 0.2)",
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: function (context) {
              const xValue = context.parsed.x;
              if (xValue === 10000 || xValue === 25000 || xValue === 50000 || xValue === 75000) {
                return 4;
              }
              return 0;
            },
            pointBackgroundColor: "saddlebrown",
            z: 1
          }
        ]
      },
      options: {
        plugins: {
          legend: {display: false}
        },
        parsing: false,
        scales: {
          x: {
            type: "linear",
            min: 0,
            max: 75000,
            ticks: {
              callback: function (value) {
                if (value === 0) {
                  return "Start";
                }
                if (value === 10000) {
                  return "10k";
                }
                if (value === 25000) {
                  return "25k";
                }
                if (value === 50000) {
                  return "50k";
                }
                if (value === 75000) {
                  return "75k";
                }
                return value;
              }
            }
          },
          y: {
            min: 0,
            max: 75000,
            ticks: {
              callback: function (value) {
                return value;
              }
            }
          }
        }
      }
    });
  }

  function checkGoals(total) {
    const goals = [10000, 25000, 50000, 75000];
    goals.forEach((goal, index) => {
      const checkbox = document.getElementById(`goal${index + 1}Check`);
      const listItem = checkbox.parentElement;
      if (total >= goal) {
        checkbox.checked = true;
        listItem.classList.add("completed");
      } else {
        checkbox.checked = false;
        listItem.classList.remove("completed");
      }
    });
    updateGoalBanner(total);
  }

  function updateGoalBanner(total) {
    const goals = [10000, 25000, 50000, 75000];
    let lastGoal = "-";
    let lastReachedGoal = "";

    goals.forEach((goal, index) => {
      const goalCheck = document.getElementById(`goal${index + 1}Check`);
      if (total >= goal) {
        goalCheck.checked = true;
        lastReachedGoal = goalCheck.nextElementSibling.innerHTML; // Get the goal description
      } else {
        goalCheck.checked = false;
      }
    });

    if (lastReachedGoal === "") {
      document.getElementById("goalBanner").innerHTML = "Noch kein Ziel erreicht üòÆ";
    } else {
      document.getElementById("goalBanner").innerHTML = `üéâ Ziel erreicht: ${lastReachedGoal.replace(
          /<[^>]*>/g, '')}!`;
    }
    document.getElementById("goalBanner").style.display = "block";
  }

  loadData();
</script>

</body>
</html>
